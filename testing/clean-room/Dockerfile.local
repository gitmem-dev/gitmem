# GitMem Clean Room â€” Local Build Test
#
# Same as Dockerfile.npm but installs from local tarball instead of npm.
#
# Build & run:
#   cd /workspace/gitmem && npm pack && cp gitmem-mcp-*.tgz testing/clean-room/gitmem-mcp-local.tgz
#   docker build -t gitmem-local -f testing/clean-room/Dockerfile.local testing/clean-room/
#   docker run -it --rm gitmem-local

FROM node:20-slim

# System dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    jq \
  && rm -rf /var/lib/apt/lists/*

# Keep npm current (suppresses upgrade nag for users)
RUN npm install -g npm@latest

# Install Claude Code (as root, before user switch)
RUN npm install -g @anthropic-ai/claude-code

# Copy and install local tarball globally so npx resolves it
COPY gitmem-mcp-local.tgz /tmp/gitmem-mcp-local.tgz
RUN npm install -g /tmp/gitmem-mcp-local.tgz && rm /tmp/gitmem-mcp-local.tgz

# Create non-root developer user with project dir
RUN useradd -m -s /bin/bash developer \
 && mkdir -p /home/developer/my-project \
 && chown developer:developer /home/developer/my-project
USER developer
WORKDIR /home/developer/my-project

# Init a git repo (gitmem expects one)
RUN git init && git config user.email "dev@test.local" && git config user.name "Test Dev"

# Nothing else. Bare project. Just like a real new user.
CMD ["bash"]
