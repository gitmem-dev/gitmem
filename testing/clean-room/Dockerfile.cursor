# GitMem Clean Room — Cursor IDE New User Experience
#
# Simulates a brand new Cursor user with nothing installed.
# No gitmem, no pre-config — just node + git + cursor CLI.
# Mirrors Dockerfile.npm but with Cursor instead of Claude Code.
#
# Build (from gitmem/ root — needs the tarball):
#   npm pack  # creates gitmem-mcp-*.tgz
#   docker build -t gitmem-cursor -f testing/clean-room/Dockerfile.cursor .
#   docker run -it --rm -e CURSOR_API_KEY=$CURSOR_API_KEY gitmem-cursor
#
# Then test exactly what the website says:
#   npx gitmem-mcp init
#   cursor
#
# Expected: auto-detects Cursor, creates .cursor/mcp.json, .cursorrules, .cursor/hooks.json

FROM node:20-slim

# System dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    jq \
    ca-certificates \
  && rm -rf /var/lib/apt/lists/*

# Install Cursor CLI (as root, before user switch)
RUN curl https://cursor.com/install -fsS | bash

# Install gitmem from local tarball (not published npm — contains Cursor changes)
COPY gitmem-mcp-*.tgz /tmp/gitmem-mcp.tgz
RUN npm install -g --loglevel=error /tmp/gitmem-mcp.tgz && rm /tmp/gitmem-mcp.tgz

# Create non-root developer user with project dir
RUN useradd -m -s /bin/bash developer \
 && mkdir -p /home/developer/my-project \
 && chown developer:developer /home/developer/my-project

# Make Cursor CLI available to developer user.
# The installer puts a full package (bundled Node 24, index.js, chunks) under
# /root/.local/share/cursor-agent/versions/<ver>/. Copy the whole thing to a
# shared location so the non-root user can run it.
RUN CURSOR_DIR=$(readlink -f /root/.local/bin/agent | xargs dirname) \
 && cp -r "$CURSOR_DIR" /opt/cursor-agent \
 && chmod -R a+rX /opt/cursor-agent \
 && ln -s /opt/cursor-agent/cursor-agent /usr/local/bin/cursor

USER developer
WORKDIR /home/developer/my-project

# Init a git repo (gitmem expects one)
RUN git init && git config user.email "dev@test.local" && git config user.name "Test Dev"

# Create .cursor/ directory — this is what Cursor IDE creates on first open.
# Its presence triggers gitmem's auto-detection to choose the Cursor path.
RUN mkdir -p .cursor

# Nothing else. Bare Cursor project. Just like a real new user.
CMD ["bash"]
