name: Deploy Site

on:
  push:
    branches: [main]
    paths:
      - 'apps/docs/**'
      - 'src/tools/definitions.ts'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout gitmem repo
        uses: actions/checkout@v4

      - name: Checkout landing page repo
        uses: actions/checkout@v4
        with:
          repository: nTEG-dev/GitMem.ai-Landing
          path: _landing

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Build docs site
      - name: Install root dependencies
        run: npm ci

      - name: Build MCP server (needed for tool doc generation)
        run: npm run build

      - name: Install docs dependencies
        run: cd apps/docs && npm ci

      - name: Build docs site
        run: cd apps/docs && npm run build

      # Build landing page
      - name: Install landing dependencies
        run: cd _landing && npm ci

      - name: Build landing page
        run: cd _landing && npm run build

      # Merge outputs: landing at root, docs at /docs
      - name: Merge build outputs
        run: |
          mkdir -p _site
          cp -r _landing/build/* _site/
          cp -r apps/docs/out/docs _site/docs
          cp -r apps/docs/out/_next _site/_next
          cp apps/docs/out/llms.txt _site/llms.txt
          cp apps/docs/out/llms-full.txt _site/llms-full.txt

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy _site --project-name=gitmem-landing
